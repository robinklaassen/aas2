language: php

php:
  - 7.4

services:
  - mysql

addons:
  ssh_known_hosts: ftp.anderwijs.nl

stages:
  - test-backend
  - test-build-deploy
  - name: deploy
    if: (branch = master) AND (type = push)


jobs:
  include:
    - stage: test-backend
      install:
        - composer self-update
        - composer update
      before_script:
        - cp .env.travis .env
        - php artisan key:generate
        - php artisan migrate --seed
      script:
        - vendor/bin/phpunit
      after_script:
        - rm .env
    - stage: test-build-deploy
      install:
        - npm install
      script:
        - npm run production
        - rsync -a --include-from=deployment/file-list.txt anderwijsnl@ftp.anderwijs.nl:~/domains/anderwijs.nl/htdocs/public/test
    - stage: deploy
      script:
        - npm run production
      deploy:
        provider: script
        skip_cleanup: true
        script:
          - deployment/before_deploy.sh
          - deployment/deploy.sh
          - deployment/after_deploy.sh

install:
  - mkdir -p bootstrap/cache
  - composer self-update
  - composer install --no-interaction
  - npm install

cache:
  npm: true
  directories:
    - vendor

notifications:
  email:
    - aas@anderwijs.nl