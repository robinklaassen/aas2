language: php

php:
  - 7.4

env:
  - PHP_EXECUTABLE=php74

addons:
  ssh_known_hosts: ftp.anderwijs.nl
  mariadb: 10.2

stages:
  - test-backend
  - name: deploy
    if: (branch = master) AND (type = push)

jobs:
  include:
    - stage: test-backend
      install:
        - composer self-update
        - composer update
      before_script:
        - sudo mysql -e 'create database aas2;'
        - sudo mysql -e 'grant all on *.* to root@localhost;' || true
        - cp .env.travis .env
        - php artisan key:generate
        - php artisan migrate --seed
      script:
        - vendor/bin/phpunit
      after_script:
        - rm .env
    - stage: deploy
      install:
        - npm install
      script:
        - npm run production
      before_deploy:
        - cat deployment/deploy.partial.sh | envsubst > deployment/deploy.sh
        - openssl aes-256-cbc -K $encrypted_2197a3ced061_key -iv $encrypted_2197a3ced061_iv
          -in deploy_rsa.enc -out /tmp/deploy_rsa -d
        - eval "$(ssh-agent -s)"
        - chmod 600 /tmp/deploy_rsa
        - ssh-add /tmp/deploy_rsa
        - chmod a+x deployment/*.sh
      deploy:
        provider: script
        skip_cleanup: true
        script: deployment/deploy.sh

cache:
  npm: true
  directories:
    - vendor

notifications:
  email:
    - aas@anderwijs.nl
